#!/usr/bin/env node
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { StackConfig, loadDeploymentConfig } from '../../shared/lib/config_loader';
import { AwsSolutionsChecks, NagSuppressions } from 'cdk-nag';
import { AppPipelineStack } from '../lib/app_pipeline_stack';

async function main() {
  const app = new cdk.App();
  cdk.Aspects.of(app).add(new AwsSolutionsChecks({ verbose: true }));

  const STAGE = process.env.STAGE;
  if (!STAGE) {
    // eslint-disable-next-line no-console
    console.error('Required STAGE environment variable is not defined');
    process.exit(1);
  }

  const vpcRegion = process.env.AWS_REGION;
  if (!vpcRegion) {
    // eslint-disable-next-line no-console
    console.error('Required AWS_REGION environment variable is not defined');
    process.exit(1);
  }

  // Load configuration
  const loadedConfig: StackConfig | null = await loadDeploymentConfig(__dirname, STAGE, 'app');
  const stage = loadedConfig?.stage;
  const globalConfig = loadedConfig?.globalConfig;
  const appConfig = loadedConfig?.appConfig;
  const globalTags = loadedConfig?.globalConfig?.pipeline?.tags ?? {};

  const namePrefix = `${(globalConfig as any).project?.aws_organziation_scope}-${(globalConfig as any).project?.project_name}-${(globalConfig as any).project.module_name}`;

  new AppPipelineStack(app, `app-pipeline-anfw-${stage}`, {
    stackName: `cpp-app-${namePrefix}-${stage}`,
    env: {
      region: (globalConfig as any).base?.primary_region || '',
      account: (globalConfig as any).base?.resource_account_id || '',
    },
    namePrefix: namePrefix,
    stage: stage,
    config: appConfig,
    globalConfig: globalConfig,
    globalTags: globalTags,
  });

  // Suppress CDK NAG findings for autogenerated support stacks
  const exclusionList: string[] = [
    'Default/CrossRegionCodePipelineReplicationBucketEncryptionKey/Resource',
    'Default/CrossRegionCodePipelineReplicationBucket/Resource',
  ];

  app.node.findAll().forEach(element => {
    if (exclusionList.some(ele => element.node.path.includes(ele))) {
      NagSuppressions.addResourceSuppressions(element, [
        {
          id: 'AwsSolutions-KMS5',
          reason: 'The Key is used for pipeline artifacts and need not be rotated.',
        },
      ]);

      NagSuppressions.addResourceSuppressions(element, [
        {
          id: 'AwsSolutions-S1',
          reason: 'The Bucket is CDK managed and used for artifact storage',
        },
      ]);
    }
  });

  app.synth();
}

main().catch(error => {
  console.error('Error in main:', error);
  process.exit(1);
});
