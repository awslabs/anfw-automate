all: build

help: 
	@echo "Available targets:"
	@echo ""
	@echo "ğŸ”§ Setup Commands:"
	@echo "  setup            - Setup development environment and git hooks"
	@echo ""
	@echo "ğŸ—ï¸  Build & Test Commands:"
	@echo "  build            - Build all modules (delegates to yarn workspaces)"
	@echo "  test             - Run all tests (delegates to yarn workspaces)"
	@echo "  lint             - Run linting on all modules"
	@echo "  lint-fix         - Fix lint issues on all modules"
	@echo "  format           - Format code with Prettier"
	@echo ""
	@echo "ğŸ”’ Security Commands:"
	@echo "  security:scan    - Run comprehensive security scanning (secrets, Python, Node.js)"
	@echo "  security:secrets - Scan for hardcoded secrets with gitleaks (Docker)"
	@echo "  security:python  - Run Python security scan with bandit"
	@echo "  security:nodejs  - Run Node.js security audit"
	@echo "  security:fix     - Fix security vulnerabilities"
	@echo "  security:fix-force - Force fix vulnerabilities (may break compatibility)"
	@echo ""
	@echo "â„¹ï¸  Note: CDK NAG compliance checks run automatically during 'make build'"
	@echo ""
	@echo "ğŸš€ Deployment Commands:"
	@echo "  deploy           - Deploy all modules to AWS"
	@echo ""
	@echo "ğŸ“ Git & Commit Commands:"
	@echo "  commit           - Create a conventional commit interactively"
	@echo "  validate-commit  - Validate the last commit message"
	@echo ""
	@echo "ğŸ§¹ Utility Commands:"
	@echo "  clean            - Clean all build artifacts"
	@echo "  update           - Update all dependencies"
	@echo ""
	@echo "ğŸ“¦ Module Commands:"
	@echo "  build:<module>   - Build specific module (app, firewall, vpc, shared)"
	@echo "  test:<module>    - Test specific module"
	@echo "  deploy:<module>  - Deploy specific module"

# Core build and test commands (delegate to yarn workspaces)
build:
	@echo "ğŸ—ï¸  Building all modules..."
	yarn build

test:
	@echo "ğŸ§ª Running all tests..."
	@for module in shared app firewall vpc; do \
		echo "Testing $$module..."; \
		(cd "$$module" && make test); \
	done

lint:
	@echo "ğŸ” Running linting on all modules..."
	@for module in shared app firewall vpc; do \
		echo "Linting $$module..."; \
		(cd "$$module" && make lint); \
	done

lint-fix:
	@echo "ğŸ”§ Fixing lint issues on all modules..."
	@for module in shared app firewall vpc; do \
		echo "Fixing $$module..."; \
		(cd "$$module" && make lint-fix); \
	done

format:
	@echo "ğŸ¨ Formatting code with Prettier..."
	yarn prettier --write "**/*.{ts,js,json,md,yml,yaml}" --ignore-path .prettierignore

# Security commands (pattern rule)
security\:%:
	@case "$*" in \
		scan) \
			echo "ğŸ”’ Running comprehensive security scanning..."; \
			./scripts/security-scan.sh all ;; \
		python) \
			echo "ğŸ Running Python security scan..."; \
			./scripts/security-scan.sh python ;; \
		nodejs) \
			echo "ğŸ“¦ Running Node.js security audit..."; \
			./scripts/security-scan.sh nodejs ;; \
		secrets) \
			echo "ğŸ” Scanning for hardcoded secrets with gitleaks..."; \
			if ! command -v docker &> /dev/null; then \
				echo "âŒ ERROR: Docker is required for gitleaks"; \
				echo "   Install Docker: https://docs.docker.com/get-docker/"; \
				exit 1; \
			fi; \
			docker run --rm -v "$$(pwd):/path" zricethezav/gitleaks:latest detect --source /path --no-git --config /path/.gitleaks.toml --verbose ;; \
		fix) \
			echo "ğŸ”§ Fixing security vulnerabilities..."; \
			echo "ğŸ“‹ Note: Bundled npm dependencies cannot be auto-fixed and require npm updates"; \
			echo ""; \
			for module in . app firewall vpc shared; do \
				if [ -f "$$module/package.json" ]; then \
					echo "  ğŸ“¦ Fixing $$module..."; \
					(cd "$$module" && yarn up '*' --mode=update-lockfile) || true; \
				fi; \
			done; \
			echo ""; \
			echo "âœ… Project module security fixes completed!"; \
			echo "â„¹ï¸  If bundled vulnerabilities remain in Yarn itself, update Yarn: corepack prepare yarn@stable --activate" ;; \
		fix-force) \
			echo "ğŸ”§ Force fixing security vulnerabilities (may introduce breaking changes)..."; \
			echo "âš ï¸  This will attempt to force-fix all vulnerabilities, including major version updates"; \
			echo ""; \
			for module in . app firewall vpc shared; do \
				if [ -f "$$module/package.json" ]; then \
					echo "  ğŸ“¦ Force fixing $$module..."; \
					(cd "$$module" && yarn up '*' --force) || true; \
				fi; \
			done; \
			echo ""; \
			echo "âš ï¸  Force fixes completed - review changes carefully!" ;; \
		*) \
			echo "Unknown security target: $*"; \
			echo "Available: scan, python, nodejs, secrets, fix, fix-force, status"; \
			exit 1 ;; \
	esac

# Module-specific commands
build\:%:
	@echo "ğŸ—ï¸  Building $* module..."
	@cd $* && make build

test\:%:
	@echo "ğŸ§ª Testing $* module..."
	@cd $* && make test

deploy\:%:
	@echo "ğŸš€ Deploying $* module..."
	@cd $* && make deploy

# Setup and environment commands
setup:
	@echo "ğŸ”§ Setting up development environment..."
	corepack enable
	yarn install
	yarn prepare
	@echo "âœ… Development environment ready!"
	@echo ""
	@echo "â„¹ï¸  Note: Docker is required for gitleaks (make security:secrets)"

# Git and commit commands
commit:
	@echo "ğŸ“ Creating a conventional commit..."
	@echo "â„¹ï¸  Note: Pre-commit hooks will run linting and security scans automatically"
	@echo ""
	@yarn commit

validate-commit:
	@echo "âœ… Validating last commit message..."
	git log -1 --pretty=format:"%s" | yarn exec commitlint

# Deployment commands
deploy: build	
	@echo "ğŸš€ Deploying all modules..."
	@for module in app firewall vpc; do \
		echo "Deploying $$module..."; \
		(cd "$$module" && make deploy); \
	done

# Utility commands
clean:
	@echo "ğŸ§¹ Cleaning all artifacts..."
	yarn clean

update: 
	@echo "ğŸ“¦ Updating all dependencies..."
	yarn up '*'

.PHONY: all help build test lint lint-fix format setup commit validate-commit deploy clean update