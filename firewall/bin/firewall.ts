#!/usr/bin/env node
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import {
  StackConfig,
  createConfigurationManager,
  ConfigurationError,
} from '../../shared/lib/config_loader';
import { AwsSolutionsChecks, NagSuppressions } from 'cdk-nag';
import { FirewallPipelineStack } from '../lib/firewall_pipeline_stack';

async function main() {
  const app = new cdk.App();
  cdk.Aspects.of(app).add(new AwsSolutionsChecks({ verbose: true }));

  const STAGE = process.env.STAGE;
  if (!STAGE) {
    // eslint-disable-next-line no-console
    console.error('Required STAGE environment variable is not defined');
    process.exit(1);
  }

  const vpcRegion = process.env.AWS_REGION;
  if (!vpcRegion) {
    // eslint-disable-next-line no-console
    console.error('Required AWS_REGION environment variable is not defined');
    process.exit(1);
  }

  try {
    // Load configuration using enhanced configuration management
    const configManager = createConfigurationManager();
    const loadedConfig: StackConfig = await configManager.loadConfig('firewall', STAGE);

    const stage = loadedConfig.stage;
    const globalConfig = loadedConfig.globalConfig;
    const firewallConfig = loadedConfig.fwConfig;
    const globalTags = loadedConfig.globalConfig?.pipeline?.tags ?? {};

    const namePrefix = `${globalConfig.project.aws_organziation_scope}-${globalConfig.project.project_name}-${globalConfig.project.module_name}`;

    // eslint-disable-next-line no-console
    console.log(`âœ… Configuration loaded successfully for firewall module in stage '${STAGE}'`);
    // eslint-disable-next-line no-console
    console.log(`ðŸ“‹ Name prefix: ${namePrefix}`);
    // eslint-disable-next-line no-console
    console.log(`ðŸŒ Region: ${globalConfig.base.primary_region}`);
    // eslint-disable-next-line no-console
    console.log(`ðŸ¢ Account: ${globalConfig.base.resource_account_id}`);

    new FirewallPipelineStack(app, `fw-pipeline-anfw-${stage}`, {
      stackName: `cpp-fw-${namePrefix}-${stage}`,
      env: {
        region: globalConfig.base.primary_region || '',
        account: globalConfig.base.resource_account_id || '',
      },
      namePrefix: namePrefix,
      stage: stage,
      config: firewallConfig,
      globalConfig: globalConfig,
      globalTags: globalTags,
    });

    // Suppress CDK NAG findings for autogenerated support stacks
    const exclusionList: string[] = [
      'Default/CrossRegionCodePipelineReplicationBucketEncryptionKey/Resource',
      'Default/CrossRegionCodePipelineReplicationBucket/Resource',
    ];

    app.node.findAll().forEach(element => {
      if (exclusionList.some(ele => element.node.path.includes(ele))) {
        NagSuppressions.addResourceSuppressions(element, [
          {
            id: 'AwsSolutions-KMS5',
            reason: 'The Key is used for pipeline artifacts and need not be rotated.',
          },
        ]);

        NagSuppressions.addResourceSuppressions(element, [
          {
            id: 'AwsSolutions-S1',
            reason: 'The Bucket is CDK managed and used for artifact storage',
          },
        ]);
      }
    });

    app.synth();
  } catch (error) {
    if (error instanceof ConfigurationError) {
      // eslint-disable-next-line no-console
      console.error('âŒ Configuration Error:');
      // eslint-disable-next-line no-console
      console.error(error.getDetailedMessage());
      // eslint-disable-next-line no-console
      console.error('\nðŸ’¡ Troubleshooting:');
      // eslint-disable-next-line no-console
      console.error(`   - Check that configuration exists for stage '${STAGE}'`);
      // eslint-disable-next-line no-console
      console.error(`   - Verify SSM parameter: /anfw-automate/${STAGE}/global/config`);
      // eslint-disable-next-line no-console
      console.error(`   - Verify SSM parameter: /anfw-automate/${STAGE}/firewall/config`);
      // eslint-disable-next-line no-console
      console.error(`   - Or check files: conf/${STAGE}.json and firewall/conf/${STAGE}.json`);
    } else {
      // eslint-disable-next-line no-console
      console.error('âŒ Unexpected error:', error);
    }
    process.exit(1);
  }
}

main().catch(error => {
  // eslint-disable-next-line no-console
  console.error('Error in main:', error);
  process.exit(1);
});
