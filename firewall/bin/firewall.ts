#!/usr/bin/env node
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { StackConfig, loadDeploymentConfig } from '../../shared/lib/config_loader'
import { AwsSolutionsChecks, NagSuppressions } from "cdk-nag";
import { FirewallPipelineStack } from "../lib/firewall_pipeline_stack";

const app = new cdk.App()
cdk.Aspects.of(app).add(new AwsSolutionsChecks({ verbose: true }));

const STAGE = process.env.STAGE;
if (!STAGE) {
  console.error('Required STAGE environment variable is not defined');
  process.exit(1);
}

const vpcRegion = process.env.AWS_REGION
if (!vpcRegion) {
  console.error('Required AWS_REGION environment variable is not defined');
  process.exit(1);
}

const STACK_NAME = "firewall";

// Load configuration
const loadedConfig: StackConfig | null = loadDeploymentConfig(__dirname, STAGE, STACK_NAME);
const stage = loadedConfig?.stage
const globalConfig = loadedConfig?.globalConfig
const firewallConfig = loadedConfig?.fwConfig

const namePrefix = `${(globalConfig as any).project?.aws_organziation_scope}-${(globalConfig as any).project?.project_name}-${(globalConfig as any).project.module_name}`

if (STACK_NAME === 'firewall' || STACK_NAME === 'all') {
  new FirewallPipelineStack(app, `fw-pipeline-anfw-${stage}`, {
    stackName: `cpp-fw-${namePrefix}-${stage}`,
    env: {
      region: (globalConfig as any).base?.primary_region || "",
      account: (globalConfig as any).base?.resource_account_id || ""
    },
    namePrefix: namePrefix,
    stage: stage,
    config: firewallConfig,
    globalConfig: globalConfig,
  });
}

// Suppress CDK NAG findings for autogenerated support stacks
const exclusionList: string[] = [
  'Default/CrossRegionCodePipelineReplicationBucketEncryptionKey/Resource',
  'Default/CrossRegionCodePipelineReplicationBucket/Resource',
];

app.node.findAll().forEach(element => {
  if (exclusionList.some(ele => element.node.path.includes(ele))) {
    NagSuppressions.addResourceSuppressions(element, [{
      id: 'AwsSolutions-KMS5',
      reason: 'The Key is used for pipeline artifacts and need not be rotated.',
    }]);

    NagSuppressions.addResourceSuppressions(element, [{
      id: 'AwsSolutions-S1',
      reason: 'The Bucket is CDK managed and used for artifact storage',
    }]);

  }
});

app.synth();
