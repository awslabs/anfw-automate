#!/usr/bin/env sh

echo "ğŸš€ Running pre-push checks..."

# Skip all checks in CI environment (GitHub Actions)
if [ "$CI" = "true" ] || [ "$GITHUB_ACTIONS" = "true" ]; then
    echo "â„¹ï¸  Running in CI environment, skipping pre-push checks"
    exit 0
fi

# Get the current branch
current_branch=$(git rev-parse --abbrev-ref HEAD)

# Skip checks for main and dev branches (they should go through PR)
if [ "$current_branch" = "main" ] || [ "$current_branch" = "dev" ]; then
    echo "âš ï¸  Direct push to $current_branch detected. Please use Pull Requests for main/dev branches."
    echo "   If this is intentional (e.g., hotfix), use --no-verify to bypass this check."
    exit 1
fi

# Run full linting on all modules
echo "ğŸ” Running linting on all modules..."
if ! make lint; then
    echo ""
    echo "âŒ Linting failed. Fix issues before pushing."
    exit 1
fi

# Run comprehensive security scan
echo "ğŸ”’ Running comprehensive security scan..."
if ! make security-scan; then
    echo ""
    echo "âŒ Security scan failed. Fix issues before pushing."
    exit 1
fi

# Run tests before push
echo "ğŸ§ª Running tests..."
if ! npm test; then
    echo ""
    echo "âŒ Tests failed. Fix issues before pushing."
    exit 1
fi

echo "âœ… Pre-push checks passed!"
