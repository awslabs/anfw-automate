echo "üîç Running pre-commit checks..."

# Validate branch name (fast)
npm run validate:branch

# Run lint-staged (handles formatting of staged files only - fast)
npx lint-staged

# Security checks on staged files (fast)
echo "üîí Running security checks on staged files..."

# Check for hardcoded secrets/credentials
echo "  Checking for hardcoded secrets..."
git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|js|py|json|yaml|yml)$' | while read -r file; do
    if [ -f "$file" ]; then
        # Check for common secret patterns
        if grep -qE '(password|secret|api[_-]?key|token|credential|private[_-]?key).*[=:].*["\047][A-Za-z0-9+/=]{16,}' "$file" 2>/dev/null; then
            echo "‚ùå ERROR: Possible hardcoded secret detected in $file"
            echo "   Please remove sensitive data before committing"
            exit 1
        fi
        # Check for AWS keys
        if grep -qE '(AKIA[0-9A-Z]{16}|aws_access_key_id|aws_secret_access_key)' "$file" 2>/dev/null; then
            echo "‚ùå ERROR: Possible AWS credentials detected in $file"
            exit 1
        fi
    fi
done

# Run Python security scan on staged Python files (fast - only staged files)
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)
if [ -n "$STAGED_PY_FILES" ]; then
    echo "  Running bandit on staged Python files..."
    if command -v bandit >/dev/null 2>&1; then
        echo "$STAGED_PY_FILES" | xargs bandit -ll -c bandit.yaml 2>/dev/null || {
            echo "‚ö†Ô∏è  Bandit found security issues in Python files"
            echo "   Run 'make security-python' for details"
            exit 1
        }
    else
        echo "  ‚ö†Ô∏è  Bandit not installed, skipping Python security scan"
        echo "     Install with: pip install bandit"
    fi
fi

# Check for common security anti-patterns in TypeScript/JavaScript (fast)
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|js)$' || true)
if [ -n "$STAGED_TS_FILES" ]; then
    echo "  Checking TypeScript/JavaScript for security issues..."
    echo "$STAGED_TS_FILES" | while read -r file; do
        if [ -f "$file" ]; then
            # Check for eval usage
            if grep -qE '\beval\s*\(' "$file" 2>/dev/null; then
                echo "‚ö†Ô∏è  WARNING: eval() usage detected in $file"
            fi
            # Check for dangerous innerHTML
            if grep -qE 'innerHTML\s*=' "$file" 2>/dev/null; then
                echo "‚ö†Ô∏è  WARNING: innerHTML usage detected in $file (XSS risk)"
            fi
        fi
    done
fi

echo "‚úÖ Pre-commit checks passed!"
echo "‚ÑπÔ∏è  Note: Full linting and security scans will run on git push"
